<html>
{% include "header.html" %}

{% load staticfiles %}
<head>
<title> Checkout </title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script> 
<script>
// When user selects "new location"
$(document).ready(function (){

	$("#select_location").change(function() {
	    // Only show the submenus from selected components
	    if ($(this).val() == "default") {
			$("#DelivLocation").hide();
			$("#PomonaDormType").hide();
			$("#CMCDormType").hide();
			$("#PitzerDormType").hide();
			$("#MuddDormType").hide();
			$("#ScrippsDormType").hide();
			$("#OffCampusType").hide();
		} else if ($(this).val() == "change") {
			$("#DelivLocation").show();
		}
	});
	$("#DelivLocation").change(function() {
	    // Only show the submenus from selected components
	    if ($(this).val() == "Pomona") {
			$("#PomonaDormType").show();
			$("#CMCDormType").hide();
			$("#PitzerDormType").hide();
			$("#MuddDormType").hide();
			$("#ScrippsDormType").hide();
			$("#OffCampusType").hide();
		} else if ($(this).val() == "Claremont McKenna") {
			$("#PomonaDormType").hide();
			$("#CMCDormType").show();
			$("#PitzerDormType").hide();
			$("#MuddDormType").hide();
			$("#ScrippsDormType").hide();
			$("#OffCampusType").hide();
		} else if ($(this).val() == "Scripps") {
			$("#PomonaDormType").hide();
			$("#CMCDormType").hide();
			$("#PitzerDormType").hide();
			$("#MuddDormType").hide();
			$("#ScrippsDormType").show();
			$("#OffCampusType").hide();
		} else if ($(this).val() == "Pitzer") {
			$("#PomonaDormType").hide();
			$("#CMCDormType").hide();
			$("#PitzerDormType").show();
			$("#MuddDormType").hide();
			$("#ScrippsDormType").hide();
			$("#OffCampusType").hide();
		} else if ($(this).val() == "Harvey Mudd") {
			$("#PomonaDormType").hide();
			$("#CMCDormType").hide();
			$("#PitzerDormType").hide();
			$("#MuddDormType").show();
			$("#ScrippsDormType").hide();
			$("#OffCampusType").hide();
		} else if ($(this).val() == "Off Campus") {
			$("#PomonaDormType").hide();
			$("#CMCDormType").hide();
			$("#PitzerDormType").hide();
			$("#MuddDormType").hide();
			$("#ScrippsDormType").hide();
			$("#OffCampusType").show();
		}
	});
});
</script>


</head>

<body>


<div id="menu" class="checkout_menu" >
<div id="orders" class="checkout" align="center" ><div id="order_title">Your Order: </div>
		
		<div id="checkout_table">
		{% for index, order in orders.items %}
		    <table id="table_list">
		    {% if order.food == "Shake" %}
		    <tr><td><b>{{order.type}} {{order.food}}</b></td>
		    {%endif%}
		    {% if order.food == "Drink" %}
		    <tr><td><b>{{order.type}} </b></td></tr>
		    {% endif%}
		    {% if order.food == "Cheeseburger" or order.food == "Hamburger" %}
		    <tr><td><b>{{order.food}}, {{order.type}}</b></td>
		    {% endif%}
		    {% if order.food == "French Fries" %}
		    <tr><td><b>{{order.food}}</b></td>
		    {%endif%}
		    
		    <td id="price_col" >${{order.price}}</td> </tr>
		    
		    {% if order.animal == 'yes' %}
		    <tr><td id="added_desc" >Animal Style</td></tr>{% endif %}
		    
		    {% if order.desc %}
		    <tr><td id="added_desc" ><i>{{order.desc}}</i></td></tr>
		    {% endif %}
		    
		    <tr></tr></table><p></p>
		    
		{% endfor %}

		<table id="table_list">
		    <tr>
		    	<td >Tip for Delivery:</td>
		    	<td><input type="text" id="tip_box" onKeyUp="tipChanged()" placeholder="{{ tip_suggestion }}"></td>
		    </tr>
		</table>

		<!-- Show order total -->
	    <span id="order_total_orig" style="display:none;">{{order_total}}</span>
		<table id="table_list">total: $<span id="order_total">{{order_total}}</span></table>

		<!-- Get Delivery Location -->
		<form action="process" id="pay" method="post">{% csrf_token %}

			<input type="hidden" name="orders" value="{{orders}}"/>

			<br>deliver to:<br>
			<select id="select_location" class="checkout_location" name="delivery_location">
			    <option selected value="default" >{{location}}</option>
			    <option value="change" > New Delivery Location</option>
			</select>
			<br>
			<!-- Get Delivery Location (if not default) -->
			<select class="checkout_location" style="display:none;" id="DelivLocation" name="register_location">
			    <option value="default" selected="" disabled="" >Which School?</option>
			    <option value="Pomona" >Pomona</option>
			    <option value="Claremont McKenna" >Claremont McKenna</option>
			    <option value="Pitzer" >Pitzer</option>
			    <option value="Scripps" >Scripps</option>
			    <option value="Harvey Mudd" >Harvey Mudd</option>
			    <option value="Off Campus" >Off-Campus (Claremont Only)</option>
			</select><br>
			<!-- If Pomona -->
			<select class="checkout_location" style="display:none;" id="PomonaDormType" name="register_location_dorm">
			    <option value="default" selected="" disabled="" >Which Dorm?</option>
			    <option value="Blaisdell" >Blaisdell</option>
			    <option value="Clark I" >Clark I</option>
			    <option value="Clark III" >Clark III</option>
			    <option value="Clark V" >Clark V</option>
			    <option value="Gibson" >Gibson</option>
			    <option value="Harwood" >Harwood</option>
			    <option value="Lawry" >Lawry</option>
			    <option value="Lyon" >Lyon</option>
			    <option value="Mudd" >Mudd</option>
			    <option value="Norton" >Norton</option>
			    <option value="Oldenborg" >Oldenborg</option>
			    <option value="Pomona Hall" >Pomona Hall</option>
			    <option value="Smiley" >Smiley</option>
			    <option value="Sontag Hall" >Sontag Hall</option>
			    <option value="Walker" >Walker</option>
			    <option value="Wig" >Wig</option>
			</select>
			<!-- If Pitzer -->
			<select class="checkout_location" style="display:none;" id="PitzerDormType" name="register_location_dorm">
			    <option value="default" selected="" disabled="" >Which Dorm?</option>
			    <option value="Atherton" >Atherton</option>
			    <option value="East" >East</option>
			    <option value="Mead" >Mead</option>
			    <option value="Pitzer Hall" >Pitzer Hall</option>
			    <option value="Sanborn" >Sanborn</option>
			    <option value="West" >West</option>
			</select>
			<!-- If CMC -->
			<select class="checkout_location" style="display:none;" id="CMCDormType" name="register_location_dorm">
			    <option value="default" selected="" disabled="" >Which Dorm?</option>
			    <option value="Appleby" >Appleby</option>
			    <option value="Auen" >Auen</option>
			    <option value="Beckett" >Beckett</option>
			    <option value="Benson" >Benson</option>
			    <option value="Berger" >Berger</option>
			    <option value="Boswell" >Boswell</option>
			    <option value="Claremont" >Claremont</option>
			    <option value="Fawcett" >Fawcett</option>
			    <option value="Green" >Green</option>
			    <option value="Marks" >Marks</option>
			    <option value="Phillips" >Phillips</option>
			    <option value="Senior Apartments" >Senior Apartments</option>
			    <option value="Stark" >Stark</option>
			    <option value="Wohlford" >Wohlford</option>
			</select>
			<!-- If Scripps -->
			<select class="checkout_location" style="display:none;" id="ScrippsDormType" name="register_location_dorm">
			    <option value="default" selected="" disabled="" >Which Dorm?</option>
			    <option value="Browning" >Browning</option>
			    <option value="Dorsey" >Dorsey</option>
			    <option value="Frankel" >Frankel</option>
			    <option value="Kimberly and Wilbur" >Kimberly and Wilbur</option>
			    <option value="Routt Apartments" >Routt Apartments</option>
			    <option value="Routt Hall" >Routt Hall</option>
			    <option value="Toll" >Toll</option>
			    <option value="Winkler" >Winkler</option>
			    
			</select>
			<!-- If Harvey Mudd -->
			<select class="checkout_location" style="display:none;" id="MuddDormType" name="register_location_dorm">
			    <option value="default" selected="" disabled="" >Which Dorm?</option>
			    <option value="Atwood" >Atwood</option>
			    <option value="Case" >Case</option>
			    <option value="East" >East</option>
			    <option value="Linde" >Linde</option>
			    <option value="North" >North</option>
			    <option value="Sontag" >Sontag</option>
			    <option value="South" >South</option>
			    <option value="West" >West</option>
			</select>
			<!-- If Off Campus -->
			<span id="OffCampusType" style="display:none;">
			<input class="checkout_location_input" type="text" placeholder="Your Address" name="register_location_other" /><br>
			<span style="font-size: 13px; width: 259px; display: inline-table; margin-top: 8;" id="address_warning"><i>Note: We do not deliver outside of Claremont. If you place an order, we cannot deliver it and will be unable to give a refund. Sorry!</i></span>
			</span>
		
			<!-- Pay Button (details in footer script) -->
			<input type="button" id="pay_button" value="Pay With Card"></input>
		</form>

	</div>
		
</div>


</div>
{% include "footer.html" %}
  
</body>
<script src="//checkout.stripe.com/v2/checkout.js"></script>
<script>
	var total = {{ order_total }};
	function tipChanged() {
		var orig = Number(document.getElementById("order_total_orig").innerHTML);
		var tip = document.getElementById('tip_box').value;
		if (tip == "") {
			tip = 0;
		} else {
			tip = parseFloat(tip);
		}
		var reg = /^\d*\.?\d*$/;
		if (reg.test(tip))
			{
				document.getElementById("order_total").innerHTML = (orig + tip).toFixed(2);
				total = orig + tip;
			}
	}

	// Turn JSON into string
    function stripJsonToString (json)
    {
		return JSON.stringify(json).replace(',', ', ').replace('[', '').replace(']', '');
    }

    // configure the stripe checkout, send token to  server
	var handler = StripeCheckout.configure({
		key: 'pk_test_PPM2Mljl9kJRjpFOUKqHBrBg', //change this based on stripe account
		image: "{% static 'images/burger.jpg' %}",
		token: function(token, args) {
			var $form = $('#pay');
			// add stripe token, and order total
			$form.append($('<input type="hidden" name="stripeToken" />').val(stripJsonToString(token)));
			$form.append($('<input type="hidden" name="total_amount" />').val(Math.round(total*100)));
			// and submit
			$form.get(0).submit();
			$form.prop('disabled',true);
		}
	});

  document.getElementById('pay_button').addEventListener('click', function(e) {
  	// first check that delivery input is valid, if it's not default
  	var canOpen = true;
  	if (document.getElementById('select_location').value != 'default') {
	  	//Now check that locations are filled out
		var location = document.getElementById('DelivLocation').value;
		if (location == "default") {
			alert("Please select a school for delivery")
			canOpen = false
		}
		if (canOpen) {
			// check that some dorm has been filled out
			var location_dorms = document.getElementsByName('register_location_dorm');
			var isEmpty = true;
			for (var index = 0; index < location_dorms.length; ++index) {
				if (location_dorms[index].value != "default") {
					isEmpty = false;
				}
			}
		}

		if (canOpen) {
			// check that either dorm+location are filled out, or off campus + address
			if (location == "Off Campus" && document.getElementsByName('register_location_other')[0].value == "") {
				alert("Please give an address for delivery");
				canOpen =  false;
			}
			if (location != "Off Campus" && isEmpty) {
				alert("Please choose a dorm for delivery");
				canOpen =  false;
			}
		}
	}

	// if input is valid
	if (canOpen) {
	    // Open Checkout with further options
	    handler.open({
	      name: 'Claremont Munchies',
	      description: 'bringing In-N-Out to your door',
	      amount: total*100
	    });
	    e.preventDefault();
	}
  });
</script>

</script>
</html>